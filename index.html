<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>五彩斑斓的二零二六>wu cai 
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: rgba(30, 30, 30, 0.95);
            --text-main: #eee;
            --text-muted: #888;
            --block-size: 42px;
            --gap-size: 6px;
            --accent: #4facfe;
        }

        body {
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
        }

        /* === Header === */
        header {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(18, 18, 18, 0.9);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 30px; border-bottom: 1px solid #333; box-sizing: border-box;
        }
        h1 { font-size: 1.1rem; letter-spacing: 1px; text-transform: uppercase; margin: 0; }
        .controls-btn {
            background: #333; color: #fff; border: 1px solid #555;
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 0.8rem;
        }
        .controls-btn:hover { background: #444; }

        /* === Settings Panel (New) === */
        #settings-panel {
            position: fixed;
            top: 70px; right: 20px;
            width: 340px;
            background: var(--panel-bg);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            z-index: 90;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none; /* Hidden by default */
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        #settings-panel.open { display: block; }

        .channel-group { margin-bottom: 20px; border-bottom: 1px dashed #444; padding-bottom: 15px; }
        .channel-group:last-child { border-bottom: none; margin-bottom: 0; }
        
        .ch-title { font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .dot.r { background: #ff5f5f; } .dot.g { background: #4cd964; } .dot.b { background: #4facfe; }

        .formula-line {
            display: flex; flex-wrap: wrap; align-items: center; gap: 5px; font-size: 0.8rem;
        }
        input[type="number"] {
            width: 50px; background: #222; border: 1px solid #444; color: #fff; padding: 4px; border-radius: 3px; font-family: inherit;
        }
        select {
            background: #222; border: 1px solid #444; color: #aaa; padding: 4px; border-radius: 3px; font-family: inherit;
        }

        /* === Viewport & Canvas === */
        #viewport {
            width: 100%; height: 100%; overflow: auto; cursor: grab;
            padding-top: 80px; padding-left: 40px; padding-bottom: 40px; box-sizing: border-box;
        }
        #viewport.active { cursor: grabbing; }

        .matrix-canvas { display: flex; gap: 20px; width: max-content; }
        .month-column { display: flex; flex-direction: column; gap: 15px; }
        .month-header {
            text-align: center; font-weight: bold; color: #666; font-size: 1rem;
            padding-left: 38px; text-transform: uppercase;
        }
        .days-stack { display: flex; flex-direction: column; gap: var(--gap-size); }
        .day-row { display: flex; align-items: center; gap: 8px; height: var(--block-size); }
        .weekday-label { font-size: 0.6rem; color: #444; width: 30px; text-align: right; font-weight: bold; }
        .day-row.is-weekend .weekday-label { color: #888; }

        .color-block {
            width: var(--block-size); height: var(--block-size); border-radius: 4px;
            transition: transform 0.1s, background-color 0.2s;
            position: relative; display: flex; justify-content: center; align-items: center;
        }
        .color-block.filled { background-color: #333; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .color-block.empty { background-color: transparent; border: 1px dashed rgba(255,255,255,0.05); }
        .color-block.filled:hover {
            transform: scale(1.2); z-index: 10; border: 2px solid #fff;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); cursor: pointer;
        }
        .date-hover {
            opacity: 0; font-size: 0.8rem; font-weight: bold; pointer-events: none; transition: opacity 0.2s;
        }
        .color-block.filled:hover .date-hover { opacity: 1; }

        /* === Modal === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .decoder-card {
            background: #1a1a1a; width: 380px; padding: 30px;
            border-radius: 12px; border: 1px solid #444; color: #fff; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }
        .close-btn { position: absolute; top: 15px; right: 20px; background: none; border: none; color: #666; font-size: 1.5rem; cursor: pointer; }
        .formula-row {
            display: flex; justify-content: space-between; margin-bottom: 10px; font-family: monospace; font-size: 0.8rem;
            background: #252525; padding: 10px; border-radius: 6px; align-items: center;
        }
        .copy-toast { text-align: center; margin-top: 15px; color: #4cd964; font-weight: bold; opacity: 0; transition: opacity 0.3s;}
        .copy-toast.show { opacity: 1; }
    </style>
</head>
<body>

    <header>
        <h1>2026 Color Lab</h1>
        <div class="hint">
            <button class="controls-btn" onclick="toggleSettings()">⚡ 调整公式 (Algorithm)</button>
        </div>
    </header>

    <div id="settings-panel">
        <div class="channel-group">
            <div class="ch-title"><span class="dot r"></span> Red Channel</div>
            <div class="formula-line">
                <input type="number" id="r-base" value="40">
                <select id="r-op1"><option value="+">+</option><option value="-">-</option><option value="*">×</option></select>
                (
                <select id="r-var"><option value="m">Month</option><option value="d">Day</option></select>
                <select id="r-op2"><option value="*">×</option><option value="+">+</option><option value="%">%</option><option value="/">÷</option></select>
                <input type="number" id="r-fact" value="18">
                )
            </div>
        </div>
        <div class="channel-group">
            <div class="ch-title"><span class="dot g"></span> Green Channel</div>
            <div class="formula-line">
                <input type="number" id="g-base" value="50">
                <select id="g-op1"><option value="+">+</option><option value="-">-</option><option value="*">×</option></select>
                (
                <select id="g-var"><option value="d">Day</option><option value="m">Month</option></select>
                <select id="g-op2"><option value="*">×</option><option value="+">+</option><option value="%">%</option><option value="/">÷</option></select>
                <input type="number" id="g-fact" value="6">
                )
            </div>
        </div>
        <div class="channel-group">
            <div class="ch-title"><span class="dot b"></span> Blue Channel</div>
            <div class="formula-line">
                <input type="number" id="b-base" value="210">
                <select id="b-op1"><option value="+">+</option><option value="-">-</option><option value="*">×</option></select>
                (
                <select id="b-var"><option value="d">Day</option><option value="m">Month</option></select>
                <select id="b-op2"><option value="%">%</option><option value="*">×</option><option value="+">+</option><option value="/">÷</option></select>
                <input type="number" id="b-fact" value="10">
                )
            </div>
        </div>
        <div style="margin-top:15px; text-align:right;">
            <button class="controls-btn" onclick="resetDefaults()">Reset Defaults</button>
        </div>
    </div>

    <div id="viewport">
        <div class="matrix-canvas" id="canvas-root"></div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="decoder-card" id="decoder-card">
            <button class="close-btn" onclick="closeModal()">×</button>
            <div style="display:flex; align-items:center; gap:20px; margin-bottom:20px;">
                <div id="modal-color" style="width:60px; height:60px; border-radius:50%; border:3px solid #fff;"></div>
                <div>
                    <h2 style="margin:0; font-size:1.3rem;" id="modal-date-title">Date</h2>
                    <span style="color:#888; font-family:monospace;" id="modal-hex-title">#XXXXXX</span>
                </div>
            </div>
            <div id="formulas-display">
                <div class="formula-row"><span style="color:#ff5f5f; font-weight:bold;">R</span><span id="eq-r"></span></div>
                <div class="formula-row"><span style="color:#4cd964; font-weight:bold;">G</span><span id="eq-g"></span></div>
                <div class="formula-row"><span style="color:#4facfe; font-weight:bold;">B</span><span id="eq-b"></span></div>
            </div>
            <div class="copy-toast" id="copy-msg">✓ HEX Copied</div>
        </div>
    </div>

    <script>
        const year = 2026;
        const root = document.getElementById('canvas-root');
        const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        const weekDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        
        // === 状态管理：存储当前的公式参数 ===
        const config = {
            r: { base: 40, op1: '+', var: 'm', op2: '*', fact: 18 },
            g: { base: 50, op1: '+', var: 'd', op2: '*', fact: 6 },
            b: { base: 210, op1: '+', var: 'd', op2: '%', fact: 10 }
        };

        // 辅助：Hex转换
        function toHex(num) {
            // 限制在 0-255
            const clamped = Math.min(255, Math.max(0, Math.round(num)));
            const hex = clamped.toString(16).toUpperCase();
            return hex.length === 1 ? '0' + hex : hex;
        }

        // === 核心：根据当前 Config 计算单通道数值 ===
        function calculateChannel(setting, m, d) {
            // 1. 确定变量 (m=Month Index 0-11, d=Day 1-31)
            const variable = (setting.var === 'm') ? m : d;
            const factor = parseFloat(setting.fact);
            const base = parseFloat(setting.base);

            // 2. 括号内运算: (Variable op2 Factor)
            let innerResult = 0;
            switch(setting.op2) {
                case '+': innerResult = variable + factor; break;
                case '-': innerResult = variable - factor; break;
                case '*': innerResult = variable * factor; break;
                case '/': innerResult = (factor === 0) ? 0 : variable / factor; break;
                case '%': innerResult = (factor === 0) ? 0 : variable % factor; break;
            }

            // 3. 整体运算: Base op1 InnerResult
            let finalResult = 0;
            switch(setting.op1) {
                case '+': finalResult = base + innerResult; break;
                case '-': finalResult = base - innerResult; break;
                case '*': finalResult = base * innerResult; break;
                case '/': finalResult = (innerResult === 0) ? 0 : base / innerResult; break;
            }
            
            return finalResult;
        }

        // === 1. 初始化 DOM 结构 (仅执行一次) ===
        function initDOM() {
            root.innerHTML = '';
            for (let m = 0; m < 12; m++) {
                const col = document.createElement('div');
                col.className = 'month-column';

                const header = document.createElement('div');
                header.className = 'month-header';
                header.innerText = monthNames[m];
                col.appendChild(header);

                const stack = document.createElement('div');
                stack.className = 'days-stack';

                const firstDayIndex = new Date(year, m, 1).getDay();
                const daysInMonth = new Date(year, m + 1, 0).getDate();

                // 填充前置空白 (对齐星期)
                for(let i = 0; i < firstDayIndex; i++) {
                    const row = document.createElement('div');
                    row.className = 'day-row';
                    if (i === 0 || i === 6) row.classList.add('is-weekend');
                    
                    const label = document.createElement('div');
                    label.className = 'weekday-label';
                    label.innerText = weekDays[i];
                    row.appendChild(label);

                    const block = document.createElement('div');
                    block.className = 'color-block empty';
                    row.appendChild(block);
                    stack.appendChild(row);
                }

                // 填充实体日期
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateObj = new Date(year, m, d);
                    const dayIndex = dateObj.getDay();
                    const dayName = weekDays[dayIndex];

                    const row = document.createElement('div');
                    row.className = 'day-row';
                    if (dayIndex === 0 || dayIndex === 6) row.classList.add('is-weekend');

                    const label = document.createElement('div');
                    label.className = 'weekday-label';
                    label.innerText = dayName;
                    row.appendChild(label);

                    const block = document.createElement('div');
                    block.className = 'color-block filled';
                    // 存储数据以便 updateColors 使用
                    block.dataset.m = m;
                    block.dataset.d = d;
                    block.dataset.w = dayName;
                    
                    const hoverText = document.createElement('span');
                    hoverText.className = 'date-hover';
                    hoverText.innerText = d;
                    block.appendChild(hoverText);

                    // 点击逻辑
                    block.onmouseup = (e) => {
                        if(!isDragging) {
                            handleBlockClick(block);
                        }
                    };

                    row.appendChild(block);
                    stack.appendChild(row);
                }
                col.appendChild(stack);
                root.appendChild(col);
            }
            // 初始渲染颜色
            updateColors();
        }

        // === 2. 实时更新颜色 (不重建DOM，高性能) ===
        function updateColors() {
            const blocks = document.querySelectorAll('.color-block.filled');
            blocks.forEach(block => {
                const m = parseInt(block.dataset.m);
                const d = parseInt(block.dataset.d);

                const r = calculateChannel(config.r, m, d);
                const g = calculateChannel(config.g, m, d);
                const b = calculateChannel(config.b, m, d);

                const hex = `#${toHex(r)}${toHex(g)}${toHex(b)}`;
                
                block.style.backgroundColor = hex;
                block.dataset.hex = hex; // 存一下当前hex方便复制

                // 智能文字颜色
                const hoverText = block.querySelector('.date-hover');
                if(hoverText) {
                     hoverText.style.color = (r + g + b > 480) ? "#000" : "#fff";
                }
            });
        }

        // === 3. 处理点击 ===
        function handleBlockClick(block) {
            const m = parseInt(block.dataset.m);
            const d = parseInt(block.dataset.d);
            const w = block.dataset.w;
            const hex = block.dataset.hex;

            // 计算具体数值用于展示
            const rVal = calculateChannel(config.r, m, d);
            const gVal = calculateChannel(config.g, m, d);
            const bVal = calculateChannel(config.b, m, d);

            openModal(m, d, w, hex, rVal, gVal, bVal);
            navigator.clipboard.writeText(hex);
        }

        // === UI 控制逻辑 ===
        const settingsPanel = document.getElementById('settings-panel');
        function toggleSettings() {
            settingsPanel.classList.toggle('open');
        }

        // 监听所有输入框变化
        const inputs = settingsPanel.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                syncConfigFromUI();
                updateColors();
            });
        });

        function syncConfigFromUI() {
            ['r', 'g', 'b'].forEach(ch => {
                config[ch].base = document.getElementById(`${ch}-base`).value;
                config[ch].op1 = document.getElementById(`${ch}-op1`).value;
                config[ch].var = document.getElementById(`${ch}-var`).value;
                config[ch].op2 = document.getElementById(`${ch}-op2`).value;
                config[ch].fact = document.getElementById(`${ch}-fact`).value;
            });
        }

        function resetDefaults() {
            // 恢复默认值 UI
            setUI('r', 40, '+', 'm', '*', 18);
            setUI('g', 50, '+', 'd', '*', 6);
            setUI('b', 210, '+', 'd', '%', 10);
            syncConfigFromUI();
            updateColors();
        }

        function setUI(ch, base, op1, v, op2, fact) {
            document.getElementById(`${ch}-base`).value = base;
            document.getElementById(`${ch}-op1`).value = op1;
            document.getElementById(`${ch}-var`).value = v;
            document.getElementById(`${ch}-op2`).value = op2;
            document.getElementById(`${ch}-fact`).value = fact;
        }

        // === 弹窗逻辑 ===
        const modal = document.getElementById('modal');
        const copyMsg = document.getElementById('copy-msg');

        modal.onclick = (e) => { if (e.target === modal) closeModal(); };

        function openModal(m, d, w, hex, r, g, b) {
            document.getElementById('modal-color').style.backgroundColor = hex;
            document.getElementById('modal-date-title').innerText = `${monthNames[m]} ${d} (${w})`;
            document.getElementById('modal-hex-title').innerText = hex;
            
            // 动态生成解释文本
            document.getElementById('eq-r').innerText = fmtFormula(config.r, m, d, r);
            document.getElementById('eq-g').innerText = fmtFormula(config.g, m, d, g);
            document.getElementById('eq-b').innerText = fmtFormula(config.b, m, d, b);

            copyMsg.classList.add('show');
            setTimeout(() => copyMsg.classList.remove('show'), 2000);
            modal.classList.add('active');
        }
        
        function fmtFormula(c, m, d, res) {
            const vName = (c.var === 'm') ? `Month(${m})` : `Day(${d})`;
            const val = Math.round(res);
            const clamped = Math.min(255, Math.max(0, val));
            return `${c.base} ${c.op1} (${vName} ${c.op2} ${c.fact}) = ${val} → ${toHex(clamped)}`;
        }

        function closeModal() { modal.classList.remove('active'); }

        // === 拖拽逻辑 ===
        const slider = document.getElementById('viewport');
        let isDown = false; let startX, startY, scrollLeft, scrollTop; let isDragging = false; 
        slider.addEventListener('mousedown', (e) => {
            isDown = true; isDragging = false; slider.classList.add('active');
            startX = e.pageX - slider.offsetLeft; startY = e.pageY - slider.offsetTop;
            scrollLeft = slider.scrollLeft; scrollTop = slider.scrollTop;
        });
        slider.addEventListener('mouseleave', () => { isDown = false; slider.classList.remove('active'); });
        slider.addEventListener('mouseup', () => {
            isDown = false; slider.classList.remove('active');
            setTimeout(() => isDragging = false, 50); 
        });
        slider.addEventListener('mousemove', (e) => {
            if (!isDown) return; e.preventDefault();
            const x = e.pageX - slider.offsetLeft; const y = e.pageY - slider.offsetTop;
            const walkX = (x - startX) * 1.5; const walkY = (y - startY) * 1.5;
            if (Math.abs(walkX) > 5 || Math.abs(walkY) > 5) isDragging = true;
            slider.scrollLeft = scrollLeft - walkX; slider.scrollTop = scrollTop - walkY;
        });

        // 启动
        initDOM();
    </script>
</body>

</html>
